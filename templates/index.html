<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

    <div class="container mt-4">
        <h1 class="mb-4">
            –ó–∞–ø–∏—Å–∏ ({{ total }})
            {% if current_file %}
            <small class="text-muted d-block fs-6">–§–∞–π–ª: {{ current_file }}</small>
            {% endif %}
        </h1>
        
        <div class="scraping-control mb-4">
        <div class="d-flex gap-3 align-items-center">
            <button
                id="scrapingBtn"
                class="btn btn-outline-secondary"
                onclick="startScraping()"
            >
                <span class="btn-content">
                    <i class="bi bi-arrow-repeat"></i>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
                </span>
                <span id="scrapingSpinner" class="scraping-spinner" style="display: none;">
                    <span class="spinner-border spinner-border-sm"></span>
                </span>
            </button>
            
            <div class="d-flex align-items-center gap-2">
                <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="loadJsonFile()">
                <button
                    class="btn btn-outline-primary"
                    onclick="document.getElementById('jsonFileInput').click()"
                >
                    <i class="bi bi-upload"></i>
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON
                </button>
                
                <button
                    class="btn btn-outline-info"
                    onclick="showFileSelector()"
                >
                    <i class="bi bi-folder2-open"></i>
                    –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
                </button>
            </div>
        </div>
        <small id="scrapingStatus" class="text-muted d-block mt-1"></small>
        <small id="loadStatus" class="text-muted d-block mt-1"></small>
    </div>

    <!-- Most Keywords Summary Section -->
    {% if metadata and metadata.most_keywords_summary %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-star-fill text-warning"></i>
                –¢–æ–ø-10 –ø–æ—Å—Ç–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for post in metadata.most_keywords_summary.top_posts %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <small class="text-muted">{{ post.channel }}</small>
                            <span class="badge bg-primary">{{ post.keyword_count }} <i class="bi bi-tags"></i></span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ post.summary }}</p>
                            <div class="mb-2">
                                <small class="text-muted">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</small>
                                <div class="mt-1">
                                    {% for keyword in post.keywords %}
                                    <span class="badge bg-light text-dark me-1">{{ keyword }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">{{ post.date}}</small>
                                <a href="{{ post.link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-box-arrow-up-right"></i> –û—Ç–∫—Ä—ã—Ç—å
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    –í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤: {{ metadata.most_keywords_summary.total_posts }}
                </small>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
    let statusPollingInterval = null;
    let cooldownInterval = null;
    
    // Save scroll position before page reload
    function saveScrollPosition() {
        sessionStorage.setItem('scrollPosition', window.scrollY);
    }
    
    // Restore scroll position after page load
    function restoreScrollPosition() {
        const savedPosition = sessionStorage.getItem('scrollPosition');
        if (savedPosition) {
            window.scrollTo(0, parseInt(savedPosition));
            sessionStorage.removeItem('scrollPosition');
        }
    }
    
    // Add click handlers to filter and sort buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Restore scroll position
        restoreScrollPosition();
        
        // Add click handlers to filter and sort buttons
        const filterButtons = document.querySelectorAll('a[href*="only_relevant"], a[href*="has_keywords"], a[href*="sort_keywords"]');
        filterButtons.forEach(button => {
            button.addEventListener('click', saveScrollPosition);
        });
        
        // Add click handlers to pagination links
        const paginationLinks = document.querySelectorAll('.pagination a');
        paginationLinks.forEach(link => {
            link.addEventListener('click', saveScrollPosition);
        });
        
        // Check initial scraping status (for cooldown)
        checkInitialScrapingStatus();
    });
    
    // Check initial scraping status on page load
    async function checkInitialScrapingStatus() {
        try {
            const response = await fetch('/scraping-status');
            const data = await response.json();
            
            if (data.status === 'cooldown') {
                updateScrapingButton('cooldown', `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${data.remaining}—Å`, 'btn-secondary', true);
                updateScrapingStatus(`–ö–Ω–æ–ø–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –µ—â–µ ${data.remaining} —Å–µ–∫—É–Ω–¥`, 'text-muted');
                startCooldownCountdown(data.remaining);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }
    
    // Function to load JSON file
    async function loadJsonFile() {
        const fileInput = document.getElementById('jsonFileInput');
        const file = fileInput.files[0];
        const loadStatus = document.getElementById('loadStatus');
        
        if (!file) {
            return;
        }
        
        // Show loading status
        loadStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
        loadStatus.className = 'text-info d-block mt-1';
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/load-json', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                loadStatus.textContent = data.message;
                loadStatus.className = 'text-success d-block mt-1';
                
                // Reload page to show new data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                loadStatus.textContent = data.message;
                loadStatus.className = 'text-danger d-block mt-1';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
            loadStatus.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞';
            loadStatus.className = 'text-danger d-block mt-1';
        }
        
        // Clear file input
        fileInput.value = '';
    }
    
    // Function to show file selector modal
    async function showFileSelector() {
        try {
            const response = await fetch('/available-files');
            const data = await response.json();
            
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            if (data.files.length === 0) {
                fileList.innerHTML = '<div class="text-muted text-center p-3">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö JSON —Ñ–∞–π–ª–æ–≤</div>';
            } else {
                data.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.innerHTML = `
                        <div class="fw-bold">${file.name}</div>
                        <small class="text-muted">
                            ${file.type === 'uploaded' ? 'üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª' : 
                              file.type === 'pipeline' ? '‚öôÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç pipeline' : 'üìÑ –ö–æ—Ä–Ω–µ–≤–æ–π —Ñ–∞–π–ª'}
                        </small>
                    `;
                    
                    const loadButton = document.createElement('button');
                    loadButton.className = 'btn btn-sm btn-primary';
                    loadButton.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å';
                    loadButton.onclick = () => loadSelectedFile(file.path);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(loadButton);
                    fileList.appendChild(fileItem);
                });
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('fileSelectorModal'));
            modal.show();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤');
        }
    }
    
    // Function to load selected file
    async function loadSelectedFile(filePath) {
        const loadStatus = document.getElementById('loadStatus');
        
        // Show loading status
        loadStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
        loadStatus.className = 'text-info d-block mt-1';
        
        const formData = new FormData();
        formData.append('file_path', filePath);
        
        try {
            const response = await fetch('/load-file', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                loadStatus.textContent = data.message;
                loadStatus.className = 'text-success d-block mt-1';
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('fileSelectorModal'));
                modal.hide();
                
                // Reload page to show new data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                loadStatus.textContent = data.message;
                loadStatus.className = 'text-danger d-block mt-1';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
            loadStatus.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞';
            loadStatus.className = 'text-danger d-block mt-1';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞
    async function startScraping() {
        const btn = document.getElementById('scrapingBtn');
        const spinner = document.getElementById('scrapingSpinner');
        btn.disabled = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        spinner.style.display = 'inline-block';
        
        updateScrapingButton('running', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'btn-warning', true);
        updateScrapingStatus('–ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...', 'text-info');
        
        try {
            const response = await fetch('/run-scraping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'processing') {
                startStatusPolling();
            } else if (data.status === 'already_running') {
                updateScrapingStatus('–ó–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', 'text-warning');
                setTimeout(() => {
                    updateScrapingButton('idle', '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'btn-outline-secondary', false);
                    updateScrapingStatus('', 'text-muted');
                    spinner.style.display = 'none';
                }, 2000);
            } else if (data.status === 'cooldown') {
                updateScrapingButton('cooldown', `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${data.remaining}—Å`, 'btn-secondary', true);
                updateScrapingStatus(`–ö–Ω–æ–ø–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –µ—â–µ ${data.remaining} —Å–µ–∫—É–Ω–¥`, 'text-muted');
                startCooldownCountdown(data.remaining);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞:', error);
            updateScrapingButton('failed', '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞', 'btn-danger');
            updateScrapingStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∑–∞–¥–∞—á–∏', 'text-danger');
            setTimeout(() => {
                updateScrapingButton('idle', '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'btn-outline-secondary', false);
                updateScrapingStatus('', 'text-muted');
                spinner.style.display = 'none';
            }, 3000);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
    function updateScrapingButton(state, text, className, disabled = false) {
        const btn = document.getElementById('scrapingBtn');
        const btnContent = btn.querySelector('.btn-content span:last-child');
        const icon = btn.querySelector('.bi');
        const spinner = document.getElementById('scrapingSpinner');
        
        btnContent.textContent = text;
        btn.className = `btn ${className}`;
        btn.disabled = disabled;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        if (state === 'running') {
            spinner.style.display = 'inline-block';
        } else {
            spinner.style.display = 'none';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
        if (state === 'running') {
            icon.className = 'bi bi-hourglass-split';
        } else if (state === 'completed') {
            icon.className = 'bi bi-check-circle';
        } else if (state === 'failed') {
            icon.className = 'bi bi-exclamation-triangle';
        } else {
            icon.className = 'bi bi-arrow-repeat';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function updateScrapingStatus(message, className) {
        const statusEl = document.getElementById('scrapingStatus');
        statusEl.textContent = message;
        statusEl.className = `${className} d-block mt-1`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
    function stopStatusPolling() {
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }
        stopCooldownCountdown();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
    function startStatusPolling() {
        stopStatusPolling();
        statusPollingInterval = setInterval(checkScrapingStatus, 1000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ –∫—É–ª–¥–∞—É–Ω–∞
    function startCooldownCountdown(remainingSeconds) {
        stopCooldownCountdown();
        let secondsLeft = remainingSeconds;
        
        cooldownInterval = setInterval(() => {
            secondsLeft--;
            if (secondsLeft <= 0) {
                stopCooldownCountdown();
                updateScrapingButton('idle', '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'btn-outline-secondary', false);
                updateScrapingStatus('', 'text-muted');
            } else {
                updateScrapingButton('cooldown', `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${secondsLeft}—Å`, 'btn-secondary', true);
                updateScrapingStatus(`–ö–Ω–æ–ø–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –µ—â–µ ${secondsLeft} —Å–µ–∫—É–Ω–¥`, 'text-muted');
            }
        }, 1000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ –∫—É–ª–¥–∞—É–Ω–∞
    function stopCooldownCountdown() {
        if (cooldownInterval) {
            clearInterval(cooldownInterval);
            cooldownInterval = null;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞
    function checkScrapingStatus() {
        fetch('/scraping-status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'running') {
                    updateScrapingButton('running', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 'btn-warning', true);
                    updateScrapingStatus(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö... (${data.elapsed}—Å)`, 'text-warning');
                } else if (data.status === 'completed') {
                    stopStatusPolling();
                    updateScrapingButton('completed', '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'btn-success');
                    updateScrapingStatus('‚úì –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'text-success');
                    setTimeout(() => {
                        updateScrapingButton('cooldown', '–ü–æ–¥–æ–∂–¥–∏—Ç–µ 60—Å', 'btn-secondary', true);
                        updateScrapingStatus('–ö–Ω–æ–ø–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ 60 —Å–µ–∫—É–Ω–¥', 'text-muted');
                        startCooldownCountdown(60);
                    }, 3000);
                    setTimeout(() => window.location.reload(), 1000);
                } else if (data.status === 'failed') {
                    stopStatusPolling();
                    updateScrapingButton('failed', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'btn-danger');
                    updateScrapingStatus(`–û—à–∏–±–∫–∞: ${data.result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}`, 'text-danger');
                    setTimeout(() => {
                        updateScrapingButton('idle', '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'btn-outline-secondary', false);
                        updateScrapingStatus('', 'text-muted');
                    }, 5000);
                } else if (data.status === 'cooldown') {
                    updateScrapingButton('cooldown', `–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${data.remaining}—Å`, 'btn-secondary', true);
                    updateScrapingStatus(`–ö–Ω–æ–ø–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –µ—â–µ ${data.remaining} —Å–µ–∫—É–Ω–¥`, 'text-muted');
                    startCooldownCountdown(data.remaining);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
            });
    }
    </script>
        
        <!-- –ü–æ–∏—Å–∫ -->
        <form method="get" class="mb-4" id='search_bar' onsubmit="saveScrollPosition()">
            <div class="input-group">
                <input type="text" name="search" value="{{ search }}" placeholder="–ü–æ–∏—Å–∫..." class="form-control">
                <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
            </div>
        </form>

        <!-- –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="mb-4">
            <div class="d-flex flex-wrap gap-3">
                <!-- –ö–Ω–æ–ø–∫–∞ "–¢–æ–ª—å–∫–æ –ø–æ–ª–µ–∑–Ω—ã–µ" -->
                <a 
                    href="/?page=1&per_page={{ per_page }}&search={{ search }}&only_relevant={{ not only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                    class="btn {% if only_relevant %}btn-primary{% else %}btn-outline-primary{% endif %}"
                >
                    <i class="bi bi-check-circle"></i> –¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ   
                </a>
                
                <!-- –ö–Ω–æ–ø–∫–∞ "–° –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏" -->
                <a 
                    href="/?page=1&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ not has_keywords }}&sort_keywords={{ sort_keywords }}"
                    class="btn {% if has_keywords %}btn-primary{% else %}btn-outline-primary{% endif %}"
                >
                    <i class="bi bi-tags"></i> –° –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
                </a>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
        <div class="mb-3">
            <!-- –í —à–∞–±–ª–æ–Ω–µ -->
            <a 
                href="/?sort_keywords={% if sort_keywords == 'none' %}desc{% elif sort_keywords == 'desc' %}asc{% else %}none{% endif %}"
                class="btn {% if sort_keywords != 'none' %}btn-primary{% else %}btn-outline-primary{% endif %}"
            >
                {% if sort_keywords == 'none' %}
                    <i class="bi bi-filter-circle"></i> –ö–æ–ª-–≤–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                {% elif sort_keywords == 'desc' %}
                    <i class="bi bi-sort-down"></i> –ö–æ–ª-–≤–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                {% else %}
                    <i class="bi bi-sort-up"></i> –ö–æ–ª-–≤–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                {% endif %}
            </a>
        </div>

        <nav>
            <ul class="pagination justify-content-center">
                <!-- –ö–Ω–æ–ø–∫–∞ "–í –Ω–∞—á–∞–ª–æ" -->
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page=1&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="First"
                    >
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>

                <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page={{ page - 1 }}&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="Previous"
                    >
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <!-- –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                <li class="page-item disabled">
                    <span class="page-link">
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}
                    </span>
                </li>

                <!-- –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥" -->
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page={{ page + 1 }}&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="Next"
                    >
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>

                <!-- –ö–Ω–æ–ø–∫–∞ "–í –∫–æ–Ω–µ—Ü" -->
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page={{ total_pages }}&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="Last"
                    >
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π -->
        <div class="list-group mb-4">
            {% for entry in items %}
            <a 
                href="/item/{{ entry.original_id }}?search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&page={{ page }}&per_page={{ per_page }}&sort_keywords={{ sort_keywords }}" 
                class="list-group-item list-group-item-action"
            >
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h5 class="mb-0 me-2">{{ loop.index0 + (page - 1) * per_page + 1 }}. {{ entry.item.channel }}</h5>
                            {% if entry.item.is_relevant %}
                            <span class="badge bg-success">Relevant</span>
                            {% endif %}
                            {% if entry.item.matched_keywords %}
                            <span class="badge bg-primary ms-2">{{ entry.item.matched_keywords|length }} <i class="bi bi-tags"></i></span>
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ entry.item.date}}</small>
                        <div class="text-truncate mt-1">{{ entry.item.text[:100] }}...</div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        <nav>
            <ul class="pagination justify-content-center">
                <!-- –ö–Ω–æ–ø–∫–∞ "–í –Ω–∞—á–∞–ª–æ" -->
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page=1&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="First"
                    >
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>

                <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page={{ page - 1 }}&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="Previous"
                    >
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <!-- –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                <li class="page-item disabled">
                    <span class="page-link">
                        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}
                    </span>
                </li>

                <!-- –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥" -->
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page={{ page + 1 }}&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="Next"
                    >
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>

                <!-- –ö–Ω–æ–ø–∫–∞ "–í –∫–æ–Ω–µ—Ü" -->
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a 
                        class="page-link" 
                        href="/?page={{ total_pages }}&per_page={{ per_page }}&search={{ search }}&only_relevant={{ only_relevant }}&has_keywords={{ has_keywords }}&sort_keywords={{ sort_keywords }}"
                        aria-label="Last"
                    >
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    
    <!-- File Selection Modal -->
    <div class="modal fade" id="fileSelectorModal" tabindex="-1" aria-labelledby="fileSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileSelectorModalLabel">–í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="fileList" class="list-group">
                        <!-- Files will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>